<!DOCTYPE html>
<html>
  <head><title>Run a kvm-support VM on Raspberry Pi 2 - LeonStudio</title>
  </head>
<body data-exts-scrollup="1" data-exts-autofixbar="1" data-spy="scroll">
<h3>Run a kvm-support VM on Raspberry Pi 2 
<a href="http://leonstudio.org/p/234" target="_b">(Source Origin)</a></h3></a>
<p><small>Tag</small>

<small>

<a href="http://leonstudio.org/t/KVM">KVM</a>&nbsp;&nbsp;

<a href="http://leonstudio.org/t/ARM">ARM</a>&nbsp;&nbsp;

</small>

</p>
</div>
<div class="article-body">
<p>Raspberry Pi 2 uses bcm2709 which is an ARMV7 processor. &nbsp;</p>

<PRE>
$ cat /proc/cpuinfo
Hardware    : BCM2709
Revision    : a01041
 
model name  : ARMv7 Processor rev 5 (v7l)
BogoMIPS    : 64.00
Features    : half thumb fastmult vfp edsp neon vfpv3 tls vfpv4 idiva idivt vfpd32 lpae evtstrm
CPU implementer : 0x41
CPU architecture: 7
CPU variant : 0x0
CPU part    : 0xc07
CPU revision    : 5
</PRE>

<p>The processor is CORTEX-A7 with virtualization extension. However, this feature is 
not supported in current raspbian system.</p>

<p>This article is about how to implement virtulaization for Raspberry Pi 2.</p>

<p>We use uboot+zImag+DTB to boot machine here.</p>


<p>First, enable HYP mode.</p>

<pre>
$ cat dmesg | grep CPU
[    0.154021] CPU: All CPU(s) started in SVC mode
</pre>

<p>Rsapberry Pi 2 jumps to SVC mode instead of HYP mode.</p>

<p>Solution: Build a bootloader which properly sets HYP mode before jumping to 
   0x8000.</p>

<p>So, build a new u-boot, and connect to zImage.</p>

<pre>
$ git clone https://github.com/slp/rpi2-hyp-boot.git
$ cd rpi2-hyp-boot
$ make 
</pre>

<p>this will get a bootblk.bin file which contains boot code and 32K padding, then </p>

<pre>
$ mv /boot/kernel7.img /boot/kernel7.img.bak
$ cat bootblk.bin /boot/kernel7.img.bak &gt; /boot/kernel7.img
</pre>

<pre>
$ echo "kernel_old=1" >> /boot/config.txt
</pre>

<p>This will make raspberry pi get into HYP mode.</p>

<pre>
$ dmesg | grep CPU
[    0.154131] CPU: All CPU(s) started in HYP mode.
[    0.154158] CPU: Virtualization extensions available.
</pre>

<p>However, it is not over yet, we need run kvm-support vm finally.</p>


<p>Second, modification for the host kernel.</p>

<p>make sure the following options are enabled:</p>

<ul>
  <li>Patch physical to virtual translations at runtime</code></li>
  <li>General setup -&gt; Control Group support</code></li>
  <li>System Type -&gt; Support for Large Physical Address Extension</code></li>
  <li>Boot options -&gt; Use appended device tree blob to zImage (EXPERIMENTAL)</li>
  <li>Boot options -&gt; Supplement the appended DTB with traditional ATAG 
      information</code></li>
  <li>Device Drivers -&gt; Block devices -&gt; Loopback device support</code></li>
  <li>Virtualization</code></li>
  <li>Virtualization -&gt; Kernel-based Virtual Machine (KVM) support (NEW)</li>
  <li><b>DISABLE</b> Virtualization -&gt; KVM support for Virtual GIC</li>
  <li><b>ENABLE</b> Virtualization -&gt; KVM support for Emulated GIC</li>
</ul>

<p>Then cross-compiler this kernel.</p>

<pre>
$ wget http://releases.linaro.org/14.04/components/toolchain/binaries/gcc-linaro-arm-linux-gnueabihf-4.8-2014.04_linux.tar.bz2
$ tar -xvf gcc-linaro-arm-linux-gnueabihf-4.8-2014.04_linux.tar.bz2</p>
</pre>

<p>Add the path of gcc-linaro-arm-linux-gnueabihf-4.8-2014.04_linux/bin to $PATH.</p>

<pre>
$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- zImage dtbs
</pre>

<p>Last, wrap all things to a new kernel, kernel7.img by follewing step:</p>

<pre>
$ cat rpi2-hyp-boot/bootblk.bin linux/arch/arm/boot/zImage linux/arch/arm/boot/dts/bcm2709-rpi-2-b.dtb &gt; kernel7.img
</pre>

<p>Edit <code>/boot/cmdline.txt</code> and add <code>"isolcpus=3"</code> at the of the 
line</p>

<p>Third, modifcation on QEMU.</p>

<p>Rember to let QEMU support CPU affitiy.</p>

<pre>wget http://wiki.qemu-project.org/download/qemu-2.2.0.tar.bz2</pre>

<pre>patch -p1 &lt; ~/qemu-cpu-affinity.patch</pre>

<p>After all setup, we need to build a guest vm kernel and dtb, build a rootfs. use qemu 
to boot it.</p>

<p>path-to-qemu/arm-softmmu/qemu-system-arm \</p>

<p>-enable-kvm -smp 1 -m 256 -M vexpress-a15 -cpu host \<br>
-kernel vexpress-zImage \<br>
-dtb vexpress-v2p-ca15-tc1.dtb \<br>
-append "root=/dev/vda console=ttyAMA0 rootwait" \<br>
-drive if=none,file=opensuse-factory.img,id=factory \<br>
-device virtio-blk-device,drive=factory \<br>
-monitor null -serial stdio \<br>
-nographic</p>

<p>The only tricky part is to build rootfs img file.</p>


<p>with all three steps above we could run a kvm-support machine succesfully.</p>


<p>Reference :</p>

<p>1.&nbsp;https://www.raspberrypi.org/documentation/linux/kernel/building.md</p>

<p>2.&nbsp;http://blog.flexvdi.com/2015/03/17/enabling-kvm-virtualization-on-the-raspberry-pi-2/</p>

<p>3.&nbsp;https://lwn.net/Articles/557132/</p>
</div>
<div class="article-foot">
<p>


</p>
<p class="text-right"><a href="http://leonstudio.org/@leon" target="_blank"><small>leon</small></a><small> Published by 2015-10-29 22:56</small></p>
</body></html>