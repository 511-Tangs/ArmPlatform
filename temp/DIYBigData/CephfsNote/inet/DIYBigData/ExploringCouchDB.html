<!DOCTYPE html>
<html lang="en">
  <head><title>Exploring CouchDB</title>
  </head>
  <body id="ibm-com" class="ibm-type ibm-sitenav-menu">
	
<h3 id="ibm-pagetitle-h1">Exploring CouchDB 
<a href="http://www.ibm.com/developerworks/opensource/library/os-couchdb/index.html" 
target="_b">(Source Origin)</a></h3>


<p>A document-oriented database for Web applications</p>

   <div class="ibm-col-6-2 ibm-col-medium-6-4 dw-article-metadata">
       <div>Joe Lennon<br><span>Published on March 31,  2009</span></div>
   </div>

<h4 id="N1003C">What is CouchDB?</h4>

<p>CouchDB is an open source document-oriented database-management system, accessible 
using a RESTful JavaScript Object Notation (JSON) API. The term "Couch" is an acronym 
for "Cluster Of Unreliable Commodity Hardware," reflecting the goal of CouchDB being 
extremely scalable, offering high availability and reliability, even while running on 
hardware that is typically prone to failure. CouchDB was originally written in C++, 
but in April 2008, the project moved to the Erlang OTP platform for its emphasis on 
fault
tolerance.</p>

<p>CouchDB can be installed on most POSIX systems, including Linux and Mac OS
X. Although Windows isn't currently officially supported, work is under
way on an unofficial binary installer for the Windows platform. CouchDB
can be installed from source or, where available, it can be installed
using a package manager (e.g., MacPorts on Mac OS X).</p>

<p>CouchDB is a top-level Apache Software Foundation open source project,
released under V2.0 of the Apache license. This open source license
allows the source code to be used and modified for use in other software,
so long as the copyright notice and disclaimer are preserved. Like most
open source licenses, it allows the software to be used, modified, and
distributed by users as required. Any modifications do not have to be made
available under the same license, so long as a notice of use of Apache-licensed code 
is maintained.</p>

<h4 id="N1004B">Differences between a
document-oriented and a relational database</h4>

<p>For many, the concept of a document-oriented database-management system is
difficult to grasp at first, especially if they have been working with
relational database-management systems for a long time. The reason
behind this is that similarities in the two models are few and far
between.</p>

<p>A document-oriented database is, unsurprisingly, made up of a series of
self-contained documents. This means that all of the data for the document
in question is stored in the document itself -- not in a related table as
it would be in a relational database. In fact, there are no tables, rows,
columns or relationships in a document-oriented database at all. This
means that they are schema-free; no strict schema needs to be defined in
advance of actually using the database. If a document needs to add a new
field, it can simply include that field, without adversely affecting other
documents in the database. This also documents do not have to
store empty data values for fields they do not have a value for.</p>

<p>The forthcoming book <em>CouchDB: The Definitive Guide</em> (see
<a href="#artrelatedtopics">Related topics</a>), uses the example of a business
card as a "real-world document" and describes how this would be described
in a document-oriented database as opposed to a relational one. In the
relational database, you could have four or more tables to house this
data: one for "Person," one for "Company," one for "Contact Details," and
one for the business card itself. These would all have strictly defined
columns and keys, and the data would be assembled using a series of
joins.</p>

<p>While this provides the advantage of having a single point of truth for
each piece of data, it makes it rigid and difficult to modify at a
later stage if required. It also means that the record cannot be adapted
for different circumstances. For example, one person may have a fax
number, while another may not. On a business card, you would not show "Fax:
None," you would just simply not show any fax details.</p>

<p>In a document-oriented database, each business card would be held in its
own document, each of which can define the fields it wishes to use. So the
person without a fax number does not need to define a fax value, whereas
the person with a fax number is free to do so as they please.</p>

<p>Another difference between these types of databases is in the storage of
unique identifiers. It is common for relational databases to use the
concept of primary keys, generated by an auto-increment feature or
by a sequence generator. Of course, these identifiers are only unique for
the table or database they are used on -- they can be reused by other
tables and databases. If an update operation is made at the same time on
two databases on separate networks, they cannot both accurately
retrieve the next unique identifier. CouchDB does not come with an
auto-increment or sequence feature. Instead, it assigns a Universally
    Unique Identifier (UUID) to each and every document, making it
almost impossible for another database to accidentally select the same
unique identifier.</p>

<p>Another key difference between document-oriented and relational databases
is that document-oriented databases do not support joins. This is a
consequence of there being no primary and foreign keys in CouchDB. There
are no keys to base joins on. This does not mean you cannot retrieve
a set of related data from a CouchDB database. A feature called a view
allows you to create an arbitrary relation between documents that is not
actually defined in the database itself. This means you can get all the
benefits of typical SQL join queries without the burden of predefining
their relationships in the database layer.</p>

<p>It is important to note that although document-oriented databases operate
in a different manner to relational databases, it does not mean that they
are a viable replacement. CouchDB does not set out to offer a replacement
for relational databases, but, rather, offers an alternative for those
projects where a document-oriented model is a better fit than a
traditional relational database, such as wikis, blogs and document-management 
systems.</p>

<h4 id="N1006B">How CouchDB works</h4>

<p>CouchDB is built on a powerful B-tree storage engine, which is responsible
for keeping the data in CouchDB sorted and provides a mechanism for
searching, inserting, and deleting in logarithmic amortized time. CouchDB
uses this engine for all internal data, documents, and views.</p>

<p>Because of the schema-free manner in which the database is structured,
CouchDB is dependent on the use of views to create arbitrary
relationships between documents, and to provide aggregation and reporting
features. The results of these views are computed using Map/Reduce, a
model for processing and generating large data sets using distributed
computing. The Map/Reduce model was introduced by Google, and can be
broken up into the Map step and the Reduce step. In the map step, the
document is taken by the master node and the problem is divided into
subproblems. These subproblems are then distributed to worker nodes,
which solve the problem and return the results to the master node. In the
reduce step, the master node takes the results received from the worker
nodes and combines them to get an overall result and answer to the
original problem.</p>

<p>The Map/Reduce functions in CouchDB produce key/value pairs, allowing
CouchDB to insert them into the B-tree engine, sorted by their keys. This
allows for ultra-efficient lookups by key and enhances the performance of
operations within the B-tree. In addition, this also means that the data
can be partitioned over many nodes without interfering with the ability to
query each node individually.</p>

<p>Traditional relational database management systems sometimes use locking to
manage concurrency, preventing clients from accessing data while another
client is updating that data. This prevents multiple clients from making
changes to the same set of data at the same time, but in situations where
there are many clients using the system concurrently, it is quite
common that the database can get bogged down in sorting out which client
should receive the lock and maintaining the order of the lock queue. In
CouchDB, there is no locking mechanism, instead it uses a method referred
to as Multiversion concurrency control (MVCC) -- where each client is
provided with a snapshot of the latest version of the database. This means
that no changes are seen by other users until the transaction has been
committed. Most modern databases have started to move from locking
mechanisms to MVCC, including Oracle (since V7), MySQL (when used
with InnoDB) and Microsoft SQL Server 2005 and later.</p>

<h4 id="N1007C">Documents: The building blocks of a
CouchDB database</h4>

<p>CouchDB databases store uniquely named documents and provide a RESTful JSON
API that allow applications to read and modify these documents.
All data in a CouchDB database is stored in a document, and each document
can be made up of an undefined number of fields. This means that each
document can have fields that are not defined in other documents. In other
words, the documents aren't bound to a strict database schema.</p>

<p>Each document also contains metadata (data about the data), such as a unique
document ID and revision numbers. Document fields can contain various
types of data, such as text strings, numbers, boolean (true/false) values,
etc. Fields are not bound by a size limit. Each field must be given
a unique name (documents cannot have two fields with the same name).</p>

<p>When changes are made to a CouchDB document, the changes are not actually
appended to the existing document, but rather, a new version of the entire
document, called a <em>revision,</em> is created. This means that a full history of
document modifications is maintained automatically by the database. The
document-revision system works in much the same way as a wiki or Web-based
document-management system manages revision control, except that it is all
handled automatically at the database level.</p>

<p>CouchDB does not feature locking mechanisms; two clients can load and edit
the same document at the same time. However, if one client saves their
changes, the other client will receive an edit conflict when they try to
save back their changes. This conflict can be resolved by loading the
newer version of the document, reapplying the edits and trying to save
again. CouchDB maintains data consistency by ensuring that document
updates are all or nothing -- it either works or it fails. There will
never be a partially saved document in the database.</p>

<h4 id="N1008E">Views: Getting useful information
out of CouchDB</h4>

<p>CouchDB is unstructured in nature, and while its lack of a strict
schema provides benefits in terms of flexibility and scalability, it
can make be quite difficult to actually use in real-world applications.
When you think of a relational database, you can see that for everyday
applications, the relationship between strictly defined tables is
important to give meaning to the data. However, when high performance is
required, materialized views are created to de-normalize the data. In many
ways, the document-oriented database does things the other way around. It
stores its data in a flat address space, much like a completely
de-normalized data warehouse. It then provides a view model to add
structure to the data so it can be aggregated to provide useful
meaning.</p>

<p>Views in CouchDB are created on demand and can be used to aggregate, join,
and report on documents in the database. They are built dynamically and
have no effect on the documents in the database. Views are defined in
design documents and can be replicated across instances. These design
documents contain JavaScript functions that run queries using the concept
of MapReduce. The view's map function takes the document as an argument
and performs a series of computations to determine what data should be
available via the view. If a view has a reduce function, it is used to
aggregate the results. It is passed a set of keys and values, and it
combines them to a single value. </p>

<p>Listing 1 is an example of the map and reduce functions of a CouchDB view
that counts the number of documents that have an attachment.</p>

<h5 id="N1009B">Listing 1. A typical CouchDB view</h5>

<span><div><div><div id="highlighter_668372" class="syntaxhighlighter  htmlscript">
<table cellpadding="0" cellspacing="0" border="0"><tbody>
<tr><td><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td>
    <td><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div">&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div></td>
    <td><div><div class="line number1 index0 alt2"><code class="htmlscript plain">map: function(doc) {</code></div><div class="line number2 index1 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">if (doc._attachments) {</code></div><div class="line number3 index2 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">emit("with attachment", 1);</code></div><div class="line number4 index3 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">}</code></div><div class="line number5 index4 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">else {</code></div><div class="line number6 index5 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">emit("without attachment", 1); </code></div><div class="line number7 index6 alt2"><code class="htmlscript spaces">&nbsp;&nbsp;</code><code class="htmlscript plain">}</code></div><div class="line number8 index7 alt1"><code class="htmlscript plain">}</code></div><div class="line number9 index8 alt2"><code class="htmlscript plain">reduce: function(keys, values) {</code></div><div class="line number10 index9 alt1"><code class="htmlscript spaces">&nbsp;&nbsp;&nbsp;</code><code class="htmlscript plain">return sum(values);</code></div><div class="line number11 index10 alt2"><code class="htmlscript plain">}</code></div></div></td></tr>
</tbody></table></div></div></div></span>

<p>CouchDB views can be permanent views stored inside design
document, or temporary views executed on demand. Temporary views
are resource-intensive and become slower as the amount of data stored in
the database increases. For this reason, CouchDB views should, for the
most part, be created in design documents.</p>

<h4 id="N100A2">The RESTful JSON API</h4>

<p>CouchDB offers an API as a means to retrieve data from the database. This API is 
accessible via HTTP <code>GET</code> and <code>POST</code> requests, and returns data 
in the form of JavaScript objects using JSON. This makes it easy to perform database 
operations, whatever language your application is developed in. You could simply use 
a JavaScript framework with Ajax request objects, such as Prototype, JQuery
or ExtJS -- there's no need for a server-side language for your Web
applications.</p>

<p>For the sake of simplicity and to illustrate the raw JSON responses issued
by the API, we will use the command-line tool, <code>curl</code>, in this article. This
allows you to issue <code>GET</code>,
<code>POST</code>, <code>PUT</code>, and
<code>DELETE</code> requests, and displays the raw HTTP
response received from the Web server (in this case a locally installed
CouchDB server).</p>

<p>The  request
<code>curl http://127.0.0.1:5984/</code> returns the
following response:
<code>{"couchdb":"Welcome","version":"0.8.1-incubating"}</code>. This simple API call 
is a simple <code>GET</code>
request, with the response informing us of the version of CouchDB
installed. To explicitly define the type of request being made,
we will use the <code>-X</code> parameter of curl, as in the
following request:
<code>curl -X GET http://127.0.0.1:5984/_all_dbs</code>.
This returns the following result:
<code>[]</code>.</p>

<p>In this example, we have requested a URI of a special CouchDB view that
returns a list of all databases on the CouchDB server. If we had actually
created any databases, this would have returned an array of database
names. In this instance, it returned an empty JavaScript array. Now we will
create a couple of databases, and the next time we run this request, we
should see a different result:
<code>curl -X PUT http://127.0.0.1:5984/fruit</code>.</p>

<p>The response received is: <code>{"ok":true}</code>. We then
issue a second request:
<code>curl -X PUT http://127.0.0.1:5984/vegetables</code>
and receive the same response as before. Now we're going to request a list
of databases once again:
<code>curl -X GET http://127.0.0.1:5984/_all_dbs</code>.
This time around, we get a better result than before:
<code>["fruit","vegetables"]</code>.</p>

<p>When we created these databases, they returned with an attribute "ok" with
a Boolean value of true. This indicates that the operation was successful.
But what happens if things don't go according to plan? To try and trip up
the CouchDB server, let's try to create a database with the same name as
one of the existing databases:
<code>curl -X PUT http://127.0.0.1:5984/fruit</code>.</p>

<p>This time around, we get the following response:
<code>{"error":"database_already_exists","reason":"Database \"fruit\" already exists."}</code>.</p>

<p>As you can see, CouchDB has tried to create the database, but encountered
an error in the process. As a result it has returned an attribute "error"
with the value of the error code it encountered -- in this case,
"database_already_exists." Of course, in a real-world application, we
would perform a check for the existence of an error attribute in all
responses from the CouchDB server and display a user-friendly error
message based on the error code found.</p>

<p>Let's say we no longer need the vegetables database and we want to remove it. 
To delete a database in CouchDB, we simply issue a <code>DELETE</code> HTTP request
with the name of the database appended to our base URI, as in the
following example:
<code>curl -X DELETE http://127.0.0.1:5984/vegetables</code>. This gives us the same 
successful response as the <code>PUT</code> requests performed
earlier. Now we will retrieve a list of databases using:
<code>curl -X GET http://127.0.0.1:5984/_all_dbs</code>.
This gives us the following response:
<code>["fruit"]</code>.</p>

<p>What good is a database if it doesn't have any data? The request
in Listing 2 creates a document called "apple."</p>

<h5 id="N1010C">Listing 2. Creating a document called apple</h5>

<span><div><div><div id="highlighter_578767" class="syntaxhighlighter  htmlscript">
<table cellpadding="0" cellspacing="0" border="0"><tbody>
<tr><td><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td>
    <td><div>&nbsp;</div><div>&nbsp;</div></td>
    <td><div><div class="line number1 index0 alt2"><code class="htmlscript plain">curl -X PUT http://127.0.0.1:5984/fruit/apple \</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">-H "Content-Type: application/json" -d {}</code></div></div></td></tr>
</tbody></table></div></div></div></span>

<p>The server responds with the following:
<code>{"ok":true,"id":"apple","rev":"1801185866"}</code>.</p>

<p>Now that we have created a document, let's retrieve it back from the
database:
<code>curl -X GET http://127.0.0.1:5984/fruit/apple</code>. CouchDB responds with the 
following:
<code>{"_id":"apple","_rev":"1801185866"}</code>.</p>

<p>The final API call we'll make is one that retrieves information about a
particular database -- in this instance, the fruit database:
<code>curl -X GET http://127.0.0.1:5984/fruit</code>. The response received from the 
server tells us some interesting information about the database.</p>

<h5 id="N10127">Listing 3. Response from the server</h5>

<span><div><div><div id="highlighter_602210" class="syntaxhighlighter  htmlscript">
<table cellpadding="0" cellspacing="0" border="0"><tbody>
<tr><td><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td>
    <td><div>&nbsp;</div><div>&nbsp;</div></td>
    <td><div><div class="line number1 index0 alt2"><code class="htmlscript plain">{"db_name":"fruit","doc_count":1,"doc_del_count":0,"update_seq":1,</code></div><div class="line number2 index1 alt1"><code class="htmlscript plain">"compact_running":false,"disk_size":14263}</code></div></div></td></tr>
</tbody></table></div></div></div></span>

<p>In this section we have explored several of the various API methods
available to us via the RESTful JSON API interface that CouchDB provides.
In the real world, we would not be hand-coding these HTTP requests, but
our programming or scripting language of choice would do this for us.</p>

<p>CouchDB also includes a Web application called Futon, which can be used as
a CouchDB administration tool, allowing you to maintain databases,
documents and document revisions to your heart's content. If you have
installed CouchDB on your local machine to the default 5984 port, you can
access Futon by pointing your browser to:
http://127.0.0.1:5984/_utils/. Figure 1 illustrates Futon in action.</p>

<h5 id="N10131">Figure 1. The CouchDB Futon utility in action</h5>

<img src="https://www.ibm.com/developerworks/opensource/library/os-couchdb/fig01.jpg" 
alt="The CouchDB Futon utility in action" height="395" width="531">

<p><a onclick="IBMCore.common.widget.overlay.show('N10134');return false;" 
href="#N10134">View image at full size</a></p><div></div>

<p>The RESTful API provided by CouchDB may be daunting at first for those used
to relational database-management systems, but it provides a unique and
extremely accessible means of interacting with the database. Traditional
database systems typically required a database connection to be made using
some form of SQL client, which would then accept a series of SQL
statements to retrieve data and to perform Create, Update, Delete (CRUD)
operations. Thanks to the RESTful JSON API, users can connect to CouchDB
using any software that supports the HTTP protocol. Indeed, most modern
programming and scripting languages provide some form of interface to the
HTTP protocol, meaning that CouchDB can be used in almost any development
project.</p>

<h4 id="N1013B">Summary</h4>

<p>It's still the early days as far as the Apache CouchDB project is
concerned. CouchDB is still very much considered alpha software. With that
said, CouchDB is becoming increasingly popular in Web applications, iPhone
applications, and Facebook applications. Up until now, powerful wiki, blog,
discussion forum and document-management software have worked around
relational databases to make them store document-oriented data as
efficiently as possible. As more stable releases of CouchDB become
available, however, it becomes a more attractive proposition as
the underlying database option for these types of software, taking the
pain out of document-revision management and continually changing schema
requirements.</p>

<p>Generally speaking, the reaction to CouchDB until now has been mostly
positive, although many repeatedly feel the need to argue on blogs and
forums as to which is better -- relational or document-oriented. The simple
fact of the matter is CouchDB never claimed to be a replacement for
relational databases or that it was going to become the new standard for
database development. Of course, in many scenarios the, pure simplicity of
CouchDB cannot match up to the power offered by the likes of DB2 and
Oracle. But in many other scenarios, database simplicity is exactly what
is needed, and traditional RDBMS offerings are far too bloated and
resource-intensive for the job at hand.</p><!--CMA ID: 378719-->
<!--XSLT stylesheet used to transform this file: dw-document-html-8.0.xsl--> 
       <!-- Article Resources -->
       <div>

<hr></div>
<h5 id="artdownload">Downloadable resources</h5>

<ul>
  <li><a href="http://www.ibm.com/developerworks/opensource/library/os-couchdb/os-couchdb-pdf.pdf">PDF of this content</a></li>
</ul><div>

<hr></div>

<h5 id="artrelatedtopics">Related topics</h5>

<ul>
  <li><a href="http://couchdb.apache.org/docs/intro.html">Introduction to CouchDB</a>:
      Read an introduction to CouchDB from the project's Web site. </li>
  <li>Read <a href="http://couchdb.apache.org/docs/overview.html">Technical Overview 
      of CouchDB</a>, a high-level overview of the key models and components of 
      CouchDB. </li>
  <li>Check out the  <a href="http://wiki.apache.org/couchdb/">CouchDB Wiki</a> to 
      find out how to install and use CouchDB on your own computer with this in-depth 
      wiki. </li>
  <li><em><a href="http://books.couchdb.org/relax/">CouchDB: The Definitive 
      Guide</a>:</em> Read this free online version of the O'Reilly Media book about 
      Apache CouchDB. Due to be published in September 2009. </li>
  <li>Visit <a href="http://planet.couchdb.org/">Planet CouchDB</a> an aggregated
      feed of CouchDB-related blogs. </li>
  <li>Read the Wikipedia entry for 
      <a href="http://en.wikipedia.org/wiki/CouchDB">CouchDB</a>.</li>
  <li>Follow CouchDB on <a href="http://twitter.com/CouchDB">Twitter</a>. </li>
  <li>Follow <a href="http://twitter.com/developerworks">developerWorks on 
      Twitter</a>.</li>
  <li> Download <a href="http://www.ibm.com/developerworks/downloads/">IBM product 
      evaluation versions</a> or 
      <a href="http://www.ibm.com/developerworks/downloads/soasandbox/">explore the 
      online trials in the IBM SOA Sandbox</a> and get your hands on application 
      development tools and middleware products from DB2, Lotus, Rational, Tivoli, and 
      WebSphere.</li>
</ul>
</body></html>