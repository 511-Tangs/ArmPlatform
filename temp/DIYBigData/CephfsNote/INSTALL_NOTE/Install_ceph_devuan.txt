website https://anonscm.debian.org/gitweb/?p=pkg-ceph/ceph.git

apt-get source ceph 
git clone https://alioth.debian.org/anonscm/git/pkg-ceph/ceph.git -b debian/10.2.5-7 ceph-devuan # Too old

website : https://anonscm.debian.org/cgit/pkg-ceph/ceph.git/
git clone https://anonscm.debian.org/git/pkg-ceph/ceph.git -b debian/10.2.5-7 ceph-devuan 

cp -arf ceph-devuan cephrootfs/tmp/
cp swap cephrootfs/var/

chroot cephrootfs
apt-get update ;apt-get upgrade -y
apt-get install libtool gcc git cmake autoconf bison flex gcc g++ cpp
apt-get install cython crypto libldap2-dev libsnappy-dev libleveldb-dev libblkid-dev libudev-dev libkeyutils-dev libcrypto++-dev libbeecrypt7  fuse libfuse-dev libgoogle-perftools-dev libatomic-ops-dev pkg-config libaio-dev xfslibs-dev libboost-system-dev libboost-iostreams-dev libboost-all-dev
apt-get install virtualenv python-pip
cd /tmp
tar -zxvf zstd-v1.1.3.tar.gz
cd zstd-1.1.3/
make -j3
make install
cd /tmp/
tar -zxvf rocksdbv5.4.6.tar.gz
cd rocksdb-5.4.6/
PORTABLE=1 make static_lib -j3 
PORTABLE=1 make shared_lib -j3
cd /tmp/ceph-devuan/ceph-devuan/src/rocksdb
PORTABLE=1 make static_lib -j3
PORTABLE=1 make shared_lib -j3
cd /tmp/ceph-devuan/ceph-devuan
export PORTABLE=1
Change file debian/control
remove build need package dh-systemd (>= 1.5),

root@Dev1build:/tmp/ceph-devuan/ceph-devuan# dpkg-checkbuilddeps
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
        LANGUAGE = "en_US:en",
	        LC_ALL = (unset),
		        LANG = "en_US.UTF-8"
			    are supported and installed on your system.
			    perl: warning: Falling back to the standard locale ("C").
			    dpkg-checkbuilddeps: Unmet build dependencies: cython debhelper (>= 9~) default-jdk dh-autoreconf javahelper junit4 libaio-dev libatomic-ops-dev libbabeltrace-ctf-dev libbabeltrace-dev libblkid-dev libboost-dev (>= 1.42) libboost-iostreams-dev libboost-program-options-dev (>= 1.42) libboost-random-dev libboost-regex-dev libboost-system-dev (>= 1.42) libboost-thread-dev (>= 1.42) libbz2-dev libcurl4-gnutls-dev libedit-dev libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libkeyutils-dev libldap2-dev libleveldb-dev libnss3-dev libsnappy-dev libudev-dev libxml2-dev lsb-release pkg-config python-all (>= 2.6.6-3~) python-dev python-nose python-sphinx uuid-dev uuid-runtime valgrind xfslibs-dev xfsprogs zlib1g-dev

Check packages
apt-get install cython debhelper default-jdk dh-autoreconf javahelper junit4 libaio-dev libatomic-ops-dev
apt-get install libbabeltrace-ctf-dev libbabeltrace-dev libblkid-dev libboost-dev libboost-iostreams-dev libboost-program-options-dev
apt-get install libboost-random-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbz2-dev libcurl4-gnutls-dev libedit-dev
apt-get install libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libkeyutils-dev libldap2-dev libleveldb-dev libnss3-dev libsnappy-dev
apt-get install libudev-dev libxml2-dev lsb-release pkg-config python-all python-dev python-nose python-sphinx uuid-dev uuid-runtime valgrind
apt-get install xfslibs-dev xfsprogs zlib1g-dev
dpkg-checkbuilddeps
root@Dev1build:/tmp/ceph-devuan/ceph-devuan# dpkg-checkbuilddeps
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
        LANGUAGE = "en_US:en",
	        LC_ALL = (unset),
		        LANG = "en_US.UTF-8"
			    are supported and installed on your system.
			    perl: warning: Falling back to the standard locale ("C").
			    root@Dev1build:/tmp/ceph-devuan/ceph-devuan# echo $?
			    0

dpkg-buildpackage
failed

Change debian/rules
disable systemd
dpkg-buildpackage

./autoogen.sh
libtoolize --force
aclocal
autoheader
automake --force-missing --add-missing
autoconf

mkdir objects
cd objects/
CXXFLAGS
LDFLAGS
CPPFLAGS
CFLAGS
CCASFLAGS
export CXXFLAGS='-fPIC'
export LDFLAGS='-fPIC'
export CPPFLAGS='-fPIC'
export CFLAGS='-fPIC'
export CCASFLAGS='-fPIC'
 ../configure --prefix=/usr/local/
cp ../src/ceph_ver.c src/
make -j3
lost ceph_ver.h


cd /tmp/ceph-devuan/ceph-devuan/src/rocksdb/
export PORTABLE=1
make static_lib -j3
make shared_lib -j3
rm librocksdb.so librocksdb.so.4 librocksdb.so.4.3
cp librocksdb.so.4.3.0 librocksdb.so
cd /tmp/ceph-devuan/ceph-devuan
nano debian/rules
replace
%:
        dh $@ --with javahelper,python2,autoreconf,systemd --parallel --max-parallel=$(maxparallel)

to
%:
        dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel)

nano debian/control 

remove line :
               dh-systemd (>= 1.5),

DEB_CPPFLAGS_SET="-fPIC" DEB_CFLAGS_SET="-fPIC" DEB_LDFLAGS_SET="-fPIC" DEB_CXXFLAGS_SET="-fPIC" dpkg-buildpackage -nc -b -j3

sed -ie "s|@PYTHON_EXECUTABLE@|/usr/bin/env python|" ceph.tmp
grep CEPH_GIT_NICE_VER ./ceph_ver.h | cut -f 3 -d " " | sed s/\"//g | xargs -I "{}" sed -ie "s/@CEPH_GIT_NICE_VER@/{}/g" ceph.tmp
/bin/sed: -e expression #1, char 31: unknown option to `s'
Makefile:32894: recipe for target 'ceph' failed
make[4]: *** [ceph] Error 123
make[4]: *** Waiting for unfinished jobs....
make[4]: Leaving directory '/tmp/ceph-devuan/ceph-devuan/src'
Makefile:30865: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '/tmp/ceph-devuan/ceph-devuan/src'
Makefile:12570: recipe for target 'all' failed
make[2]: *** [all] Error 2
make[2]: Leaving directory '/tmp/ceph-devuan/ceph-devuan/src'
Makefile:692: recipe for target 'all-recursive' failed
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory '/tmp/ceph-devuan/ceph-devuan'
dh_auto_build: make -j3 returned exit code 2
debian/rules:73: recipe for target 'build' failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2


### Because of Ceph version has '\', let sed failed
find ceph-version debian/10.2.5-7
.git/packed-refs:163:4b4fce19dec93ca84a99c4ca38da7221fef9d308 refs/tags/debian/10.2.5-7
src/.git_version:2:debian/10.2.5-7

# Retry from apt-get source
apt-get source ceph

# Check Version
cat src/.git_version 
c461ee19ecbc0c5c330aca20f7392c9a00730367
v10.2.5

# Retry

cd /tmp/ceph-devuan-10.2.5/ceph-10.2.5/
nano debian/control
remove line :
dh-systemd (>= 1.5),
nano debian/rules
replace

:
        dh $@ --with javahelper,python2,autoreconf,systemd --parallel --max-parallel=$(maxparallel)

to

:
        dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel)

export PORTABLE=1
cd src/rocksdb/
make static_lib -j3
make shared_lib -j3
rm librocksdb.so librocksdb.so.4 librocksdb.so.4.3
cp librocksdb.so.4.3.0 librocksdb.so
cd ../../
DEB_CPPFLAGS_SET="-fPIC" DEB_CFLAGS_SET="-fPIC" DEB_LDFLAGS_SET="-fPIC" DEB_CXXFLAGS_SET="-fPIC" dpkg-buildpackage -nc -b -j3



rocksdb/librocksdb.a(format.o): In function `ZSTD_Uncompress':
/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src/rocksdb/./util/compression.h:644: undefined reference to `ZSTD_decompress'
rocksdb/librocksdb.a(block_based_table_builder.o): In function `ZSTD_Compress':
/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src/rocksdb/./util/compression.h:620: undefined reference to `ZSTD_compressBound'
/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src/rocksdb/./util/compression.h:623: undefined reference to `ZSTD_compress'
collect2: error: ld returned 1 exit status
Makefile:15928: recipe for target 'ceph_objectstore_bench' failed
make[4]: *** [ceph_objectstore_bench] Error 1
make[4]: *** Waiting for unfinished jobs....
libtool: link: g++ -I/usr/include/nss -I/usr/include/nspr -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -fPIC -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -fPIC -o .libs/ceph_multi_stress_watch test/multi_stress_watch.o  -Wl,--as-needed /usr/lib/libatomic_ops.a ./.libs/librados.so ./.libs/libglobal.a -lpthread -lm ./.libs/libradostest.a ./.libs/libcommon.a -ldl -lboost_thread -lboost_random -lrt -lblkid -luuid -lnss3 -lnssutil3 -lsmime3 -lssl3 -lplds4 -lplc4 -lnspr4 -lboost_iostreams -lboost_system
make[4]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src'
Makefile:30865: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src'
Makefile:12570: recipe for target 'all' failed
make[2]: *** [all] Error 2
make[2]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src'
Makefile:692: recipe for target 'all-recursive' failed
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5'
dh_auto_build: make -j3 returned exit code 2
debian/rules:81: recipe for target 'build' failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2


## Remake zstd
cd /tmp/zstd-1.1.3
export LIBRARY_PATH=/usr/
make

DEB_CPPFLAGS_SET="-fPIC -I/usr/local/include/" DEB_CFLAGS_SET="-fPIC -I/usr/local/include/" DEB_LDFLAGS_SET="-fPIC -I/usr/local/include/" DEB_CXXFLAGS_SET="-fPIC -I/usr/local/include/" dpkg-buildpackage -nc -b -j3

export C_INCLUDE_PATH=${C_INCLUDE_PATH}:/usr/local/include/
export CXX_INCLUDE_PATH=${C_INCLUDE_PATH}:/usr/local/include/
export CPP_INCLUDE_PATH=${C_INCLUDE_PATH}:/usr/local/include/
DEB_CPPFLAGS_SET="-fPIC -I/usr/local/include/" DEB_CFLAGS_SET="-fPIC -I/usr/local/include/" DEB_LDFLAGS_SET="-fPIC -I/usr/local/include/" DEB_CXXFLAGS_SET="-fP\
IC -I/usr/local/include/" dpkg-buildpackage -nc -b -j3
ln -s /usr/local/include/zstd.h /usr/include/

DEB_CPPFLAGS_SET="-fPIC" DEB_CFLAGS_SET="-fPIC" DEB_LDFLAGS_SET="-fPIC" DEB_CXXFLAGS_SET="-fPIC" dpkg-buildpackage -nc -b -j3
cd /tmp/
wget https://github.com/facebook/zstd/archive/dev.zip
mkdir zstd
cd zstd
unzip ../dev.zip
cd zstd-dev/
make
 echo $?
make install
DEB_CPPFLAGS_SET+="-fPIC -I/usr/local/include/ -L/usr/local/lib" DEB_CFLAGS_SET+="-fPIC -I/usr/local/include/ -L/usr/local/lib" DEB_LDFLAGS_SET+="-fPIC -I/usr/local/include/ -L/usr/local/lib" DEB_CXXFLAGS_SET+="-fPIC -I/usr/local/include/ -L/usr/local/lib" dpkg-buildpackage -nc -b -j3




 make static_lib -j3 -I /usr/local/include -L /usr/local/lib
 make shared_lib -j3 -I /usr/local/include -L /usr/local/lib
/usr/bin/ld: rocksdb/librocksdb.a(db_impl_open.o): relocation R_ARM_THM_MOVW_ABS_NC against `a local symbol' can not be used when making a shared object; recompile with -fPIC
rocksdb/librocksdb.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Makefile:15928: recipe for target 'ceph_objectstore_bench' failed
make[4]: *** [ceph_objectstore_bench] Error 1
make[4]: *** Waiting for unfinished jobs....
make[4]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src'
Makefile:30865: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src'
Makefile:12570: recipe for target 'all' failed
make[2]: *** [all] Error 2
make[2]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5/src'
Makefile:692: recipe for target 'all-recursive' failed
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory '/tmp/ceph-devuan-10.2.5/ceph-10.2.5'
dh_auto_build: make -j3 returned exit code 2
debian/rules:81: recipe for target 'build' failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2



### Retry ALL
cd /tmp/
1. Build zstd
tar -zxvf zstd-v1.1.3.tar.gz 
cd zstd-1.1.3/
apt-get install libsnappy-dev zlib1g-dev  libbz2-dev libgflags-dev gcc g++ cpp
 git cmake autoconf bison flex
make all
make install PREFIX=/usr
 ls -l /usr/include/zstd*.h 
-rw-r--r-- 1 root root 40119 Jun 15 06:00 /usr/include/zstd.h
-rw-r--r-- 1 root root  2459 Jun 15 06:00 /usr/include/zstd_errors.h

2. Build rocksdb

cd /tmp/ceph-devuan/ceph-10.2.5/src/rocksdb/
export PORTABLE=1
make all 
make install INSTALL_PATH=/usr
make clean
make shared_lib -j3
make install-shared INSTALL_PATH=/usr
make clean
cp /usr/lib/librocksdb.a .
cp /usr/lib/librocksdb.so .

3. Install Ceph dependence

cd /tmp/ceph-devuan/ceph-10.2.5/
nano debian/control
remove line :
dh-systemd
nano debian/rule
replace line :
dh $@ --with javahelper,python2,autoreconf,systemd --parallel --max-parallel=$(maxparallel)
to
dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel)

apt-get install cython debhelper default-jdk  dh-autoreconf dh-python dpkg-dev javahelper junit4 libaio-dev libatomic-ops-dev libbabeltrace-ctf-dev libbabeltrace-dev libblkid-dev libboost-dev libboost-iostreams-dev libboost-program-options-dev libboost-random-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbz2-dev libcurl4-gnutls-dev libedit-dev libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libkeyutils-dev libldap2-dev libleveldb-dev libnss3-dev libsnappy-dev libtool libudev-dev libxml2-dev lsb-release pkg-config python-all python-dev python-nose python-setuptools python-sphinx uuid-dev uuid-runtime valgrind xfslibs-dev xfsprogs zlib1g-dev libcrypto++-dev

4. Build Ceph using dpkg-buildpackage

DEB_CPPFLAGS_SET="-fPIC" DEB_CFLAGS_SET="-fPIC" DEB_LDFLAGS_SET="-fPIC" DEB_CXXFLAGS_SET="-fPIC" dpkg-buildpackage -nc -d -j3

/usr/bin/ld: rocksdb/librocksdb.a(db_impl.o): relocation R_ARM_THM_MOVW_ABS_NC against `a local symbol' can not be used when making a shared object; recompile with -fPIC
rocksdb/librocksdb.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Makefile:15928: recipe for target 'ceph_objectstore_bench' failed
make[4]: *** [ceph_objectstore_bench] Error 1
make[4]: *** Waiting for unfinished jobs....
libtool: link: g++ -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -fPIC -g1 -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -fPIC -o .libs/ceph_kvstorebench test/kv_store_bench.o key_value_store/kv_flat_btree_async.o  /usr/lib/libatomic_ops.a -Wl,--as-needed ./.libs/librados.so ./.libs/libglobal.a ./.libs/libcommon.a -ldl -lboost_thread -latomic -lboost_random -lblkid -luuid -lpthread -lcrypto++ -lm -lrt -lboost_iostreams -lboost_system
make[4]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:30865: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:12570: recipe for target 'all' failed
make[2]: *** [all] Error 2
make[2]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:692: recipe for target 'all-recursive' failed
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5'
dh_auto_build: make -j3 returned exit code 2
debian/rules:81: recipe for target 'build' failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2



# Error on this

g++ -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -fPIC -g1 -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -fPIC -o ceph_objectstore_bench test/objectstore_bench.o -pthread  /usr/lib/libatomic_ops.a -Wl,--as-needed libos.a -laio libos_types.a libkv.a rocksdb/librocksdb.a -lbz2 -lz -lleveldb -lsnappy -lfuse ./.libs/libglobal.a ./.libs/libcommon.a -ldl -lboost_thread -latomic -lboost_random -lblkid -luuid -lpthread -lcrypto++ -lm -lrt -lboost_iostreams -lboost_system -pthread




# Retry All
1. Install deps
apt-get update 
apt-get install libsnappy-dev zlib1g-dev  libbz2-dev libgflags-dev gcc g++ cpp  git cmake autoconf bison flex cython debhelper default-jdk  dh-autoreconf dh-python dpkg-dev javahelper junit4 libaio-dev libatomic-ops-dev libbabeltrace-ctf-dev libbabeltrace-dev libblkid-dev libboost-dev libboost-iostreams-dev libboost-program-options-dev libboost-random-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbz2-dev libcurl4-gnutls-dev libedit-dev libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libkeyutils-dev libldap2-dev libleveldb-dev libnss3-dev libsnappy-dev libtool libudev-dev libxml2-dev lsb-release pkg-config python-all python-dev python-nose python-setuptools python-sphinx uuid-dev uuid-runtime valgrind xfslibs-dev xfsprogs zlib1g-dev libcrypto++-dev  localepurge locales 

2. Prepare zstd
unset LANGUAGE
export LANG=C
cd /tmp
tar -zxvf zstd-v1.1.3.tar.gz 
cd zstd-1.1.3/
make all
make install PREFIX=/usr
 ls -l /usr/include/zstd*.h 
-rw-r--r-- 1 root root 40119 Jun 15 06:00 /usr/include/zstd.h
-rw-r--r-- 1 root root  2459 Jun 15 06:00 /usr/include/zstd_errors.h


3. Prepare rocksdb

cd /tmp/ceph-devuan/ceph-10.2.5/src/rocksdb/
export PORTABLE=1
make DEBUG_LEVEL=0 static_lib -j3 
make install INSTALL_PATH=/usr
make DEBUG_LEVEL=0 shared_lib -j3 
make install-shared INSTALL_PATH=/usr

4. Change debian/rules and debian/control to clean systemd
cd /tmp/ceph-devuan/ceph-10.2.5/
nano debian/control
remove this line :
dh-systemd (>= 1.5),

nano debian/rules
replace this line :
dh $@ --with javahelper,python2,autoreconf,systemd --parallel --max-parallel=$(maxparallel)
to this line :
dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel)

5. Check Ceph version without any '/'
cat src/.git_version 
c461ee19ecbc0c5c330aca20f7392c9a00730367
v10.2.5

6. build deb package
DEB_CPPFLAGS_SET="-fPIC" DEB_CFLAGS_SET="-fPIC" DEB_LDFLAGS_SET="-fPIC" DEB_CXXFLAGS_SET="-fPIC" dpkg-buildpackage -nc -d -j3

-nc means not clean source tree
-d means not check dependence
-j3 means using three cores
DEB_CPPFLAGS_SET means add flags into CPP compiler
DEB_CFLAGS_SET means add flags into C compiler
DEB_CXXFLAGS_SET means add flags into C++ compiler
DEB_LDFLAGS_SET means add flags into LD Linker
/usr/bin/ld: rocksdb/librocksdb.a(db_impl.o): relocation R_ARM_THM_MOVW_ABS_NC against `a local symbol' can not be used when making a shared object; recompile with -fPIC
rocksdb/librocksdb.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Makefile:15928: recipe for target 'ceph_objectstore_bench' failed
make[4]: *** [ceph_objectstore_bench] Error 1
make[4]: *** Waiting for unfinished jobs....
libtool: link: g++ -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -fPIC -g1 -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -fPIC -o .libs/ceph_kvstorebench test/kv_store_bench.o key_value_store/kv_flat_btree_async.o  /usr/lib/libatomic_ops.a -Wl,--as-needed ./.libs/librados.so ./.libs/libglobal.a ./.libs/libcommon.a -ldl -lboost_thread -latomic -lboost_random -lblkid -luuid -lpthread -lcrypto++ -lm -lrt -lboost_iostreams -lboost_system
make[4]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:30865: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:12570: recipe for target 'all' failed
make[2]: *** [all] Error 2
make[2]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:692: recipe for target 'all-recursive' failed
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5'
dh_auto_build: make -j3 returned exit code 2
debian/rules:81: recipe for target 'build' failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2


# Try

cd src

 g++ -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -fPIC -g1 -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -fPIC -o ceph_objectstore_bench test/objectstore_bench.o -pthread  /usr/lib/libatomic_ops.a -Wl,--as-needed libos.a -laio libos_types.a libkv.a /usr/lib/librocksdb.a -lbz2 -lz -lleveldb -lsnappy -lfuse ./.libs/libglobal.a ./.libs/libcommon.a -ldl -lboost_thread -latomic -lboost_random -lblkid -luuid -lpthread -lcrypto++ -lm -lrt -lboost_iostreams -lboost_system -pthread

cd rocksdb
make clean

make DEBUG_LEVEL=0 static_lib -j3 CPPFLAGST="-fPIC" CFLAGS="-fPIC" LDFLAGS="-fPIC" CXXFLAGS="-fPIC"



# Retry All
1. Copy build file into rootfs

sudo tar -zxvf /src/fs/rootfs/devuan-armhf-defaultrootfs.tgz -C cephrootfs/
sudo cp rocksdbv5.4.6.tar.gz zstd-v1.1.3.tar.gz cephrootfs/tmp/
sudo cp -arf ceph-devuan cephrootfs/tmp/
sudo cp swap cephrootfs/var/

2.chroot and install dependence package

apt-get update 
apt-get install libsnappy-dev zlib1g-dev libbz2-dev libgflags-dev gcc g++ cpp  git make cmake autoconf bison flex cython debhelper default-jdk  dh-autoreconf dh-python dpkg-dev javahelper junit4 libaio-dev libatomic-ops-dev libbabeltrace-ctf-dev libbabeltrace-dev libblkid-dev libboost-dev libboost-iostreams-dev libboost-program-options-dev libboost-random-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbz2-dev libcurl4-gnutls-dev libedit-dev libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libkeyutils-dev libldap2-dev libleveldb-dev libnss3-dev libsnappy-dev libtool libudev-dev libxml2-dev lsb-release pkg-config python-all python-dev python-nose python-setuptools python-sphinx uuid-dev uuid-runtime valgrind xfslibs-dev xfsprogs zlib1g-dev libcrypto++-dev  localepurge locales

3. Prepare zstd
cd /tmp/
tar -zxvf zstd-v1.1.3.tar.gz 
cd zstd-1.1.3/
make all -j3
make install PREFIX=/usr
ls -l /usr/include/zstd*
-rw-r--r-- 1 root root 40119 Jun 17 06:33 /usr/include/zstd.h
-rw-r--r-- 1 root root  2459 Jun 17 06:33 /usr/include/zstd_errors.h

4. prepare rocksdb
cd /tmp/ceph-devuan/ceph-10.2.5/src/rocksdb/
export PORTABLE=1
make DEBUG_LEVEL=0 install-headers INSTALL_PATH=/usr
make DEBUG_LEVEL=0 shared_lib -j3
make DEBUG_LEVEL=0 install-shared INSTALL_PATH=/usr
make DEBUG_LEVEL=0 static_lib -j3
make DEBUG_LEVEL=0 install-static INSTALL_PATH=/usr
rm librocksdb.so librocksdb.so.4 librocksdb.so.4.3
cp librocksdb.so.4.3.0 librocksdb.so

5. build ceph
cd /tmp/ceph-devuan/ceph-10.2.5/
nano debian/control
remove line :
dh-systemd
nano debian/rules
replace

dh $@ --with javahelper,python2,autoreconf,systemd --parallel --max-parallel=$(maxparallel)

to

dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel)

dpkg-buildpackage -nc -d -j3


libtool: link: g++ -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -g -O2 -g1 -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -o ceph_objectstore_bench test/objectstore_bench.o -pthread  /usr/lib/libatomic_ops.a -Wl,--as-needed libos.a -laio libos_types.a libkv.a rocksdb/librocksdb.a -lbz2 -lz -lleveldb -lsnappy -lfuse ./.libs/libglobal.a ./.libs/libcommon.a -ldl -lboost_thread -latomic -lboost_random -lblkid -luuid -lpthread -lcrypto++ -lm -lrt -lboost_iostreams -lboost_system -pthread
/usr/bin/ld: rocksdb/librocksdb.a(db_impl.o): relocation R_ARM_THM_MOVW_ABS_NC against `a local symbol' can not be used when making a shared object; recompile with -fPIC
rocksdb/librocksdb.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Makefile:15928: recipe for target 'ceph_objectstore_bench' failed
make[4]: *** [ceph_objectstore_bench] Error 1
make[4]: *** Waiting for unfinished jobs....
libtool: link: g++ -Wall -Wtype-limits -Wignored-qualifiers -Winit-self -Wpointer-arith -fno-strict-aliasing -fsigned-char -rdynamic -ftemplate-depth-1024 -Wnon-virtual-dtor -Wno-invalid-offsetof -O2 -g -pipe -Wall -Wp,-U_FORTIFY_SOURCE -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -fPIE -fstack-protector-strong -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -Wstrict-null-sentinel -g -O2 -g1 -std=gnu++11 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -o .libs/ceph_kvstorebench test/kv_store_bench.o key_value_store/kv_flat_btree_async.o  /usr/lib/libatomic_ops.a -Wl,--as-needed ./.libs/librados.so ./.libs/libglobal.a ./.libs/libcommon.a -ldl -lboost_thread -latomic -lboost_random -lblkid -luuid -lpthread -lcrypto++ -lm -lrt -lboost_iostreams -lboost_system
make[4]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:30865: recipe for target 'all-recursive' failed
make[3]: *** [all-recursive] Error 1
make[3]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:12570: recipe for target 'all' failed
make[2]: *** [all] Error 2
make[2]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5/src'
Makefile:692: recipe for target 'all-recursive' failed
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5'
dh_auto_build: make -j3 returned exit code 2
debian/rules:81: recipe for target 'build' failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2


# using librocksdb.so link to librocksdb.a
cd src/rocksdb/
rm librocksdb.a
ln -s librocksdb.so.4.3.0 librocksdb.a
cd ../../
dpkg-buildpackage -nc -d -j3

   debian/rules override_dh_auto_install
   make[1]: Entering directory '/tmp/ceph-devuan/ceph-10.2.5'
   # At least on armel installation of the Python modules fails in weird ways
   # when run in parallel. As this is probably not specific to armel but just only
   # triggered there because the architecture is too slow, run without parallelism
   # everywhere.
   dh_auto_install --no-parallel
   perl: warning: Setting locale failed.
   perl: warning: Please check that your locale settings:
           LANGUAGE = "en_US:en",
	           LC_ALL = (unset),
		           LANG = "en_US.UTF-8"
			       are supported and installed on your system.
			       perl: warning: Falling back to the standard locale ("C").
			       dh_auto_install: unknown option; aborting
			       debian/rules:90: recipe for target 'override_dh_auto_install' failed
			       make[1]: *** [override_dh_auto_install] Error 255
			       make[1]: Leaving directory '/tmp/ceph-devuan/ceph-10.2.5'
			       debian/rules:81: recipe for target 'binary' failed
			       make: *** [binary] Error 2
			       dpkg-buildpackage: error: debian/rules binary gave error exit status 2


nano debian/rules
replace
        dh_auto_install --no-parallel

to
        dh_auto_install

dpkg-buildpackage -nc -d -j3

dpkg-shlibdeps: error: no dependency information found for /usr/lib/librocksdb.so.4.3 (used by debian/ceph-mon/usr/bin/ceph-mon)
Hint: check if the library actually comes from a package.
dh_shlibdeps: dpkg-shlibdeps -Tdebian/ceph-mon.substvars debian/ceph-mon/usr/bin/ceph-mon returned exit code 2
debian/rules:81: recipe for target 'binary' failed
make: *** [binary] Error 2
dpkg-buildpackage: error: debian/rules binary gave error exit status 2

cd src/rocksdb
make uninstall INSTALL_PATH=/usr
cd ../../
dpkg-buildpackage -nc -d -j3
nano debian/rules
replace
        dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel)
to
        dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel) --dpkg-shlibdeps-params=--ignore-missing-info

dpkg-buildpackage -nc -d -j3




#### Retry ALL
0. Prepare source
sudo tar -zxvf /src/fs/rootfs/devuan-armhf-defaultrootfs.tgz -C cephrootfs/
sudo cp swap cephrootfs/var/
cp -arf ceph-devuan cephrootfs/tmp/
mkdir zstd-devuan;cd zstd-devuan ; apt-get source libzstd-dev; cd ../
mkdir rocksdb-devuan ; cd rocksdb-devuan ;apt-get source librocksdb-dev ;cd ../
cp -arf zstd-devuan cephrootfs/tmp/
cp -arf rocksdb-devuan cephrootfs/tmp/


1. Chroot rootfs
apt-get update
apt-get install locales
locale-gen en_US en_US.UTF-8
dpkg-reconfigure locales
swapon /var/swap

2. Install build dependence

apt-get update
apt-get install libsnappy-dev zlib1g-dev  libbz2-dev libgflags-dev gcc g++ cpp  git cmake autoconf bison flex cytho\
n debhelper default-jdk  dh-autoreconf dh-python dpkg-dev javahelper junit4 libaio-dev libatomic-ops-dev libbabeltr\
ace-ctf-dev libbabeltrace-dev libblkid-dev libboost-dev libboost-iostreams-dev libboost-program-options-dev libboos\
t-random-dev libboost-regex-dev libboost-system-dev libboost-thread-dev libbz2-dev libcurl4-gnutls-dev libedit-dev \
libexpat1-dev libfcgi-dev libfuse-dev libgoogle-perftools-dev libkeyutils-dev libldap2-dev libleveldb-dev libnss3-d\
ev libsnappy-dev libtool libudev-dev libxml2-dev lsb-release pkg-config python-all python-dev python-nose python-se\
tuptools python-sphinx uuid-dev uuid-runtime valgrind xfslibs-dev xfsprogs zlib1g-dev libcrypto++-dev  localepurge \
locales d-shlibs

3. Prepare zstd
cd /tmp/zstd-devuan/libzstd-1.1.2/
make all -j3
make install PREFIX=/usr
ls -l /usr/include/zstd*
-rw-r--r-- 1 root root 40119 Jun 17 06:33 /usr/include/zstd.h
-rw-r--r-- 1 root root  2459 Jun 17 06:33 /usr/include/zstd_errors.h

4. Prepare rocksdb
cd /tmp/ceph-devuan/ceph-10.2.5/src/rocksdb/
export PORTABLE=1
make DEBUG_LEVEL=0 install-headers INSTALL_PATH=/usr
make DEBUG_LEVEL=0 shared_lib -j3
make DEBUG_LEVEL=0 install-shared INSTALL_PATH=/usr
ln -s librocksdb.so librocksdb.a

5. Change debian rules

cd ../../
nano debian/control
remove line :
dh-systemd

nano debian/rules
replace
        dh $@ --with javahelper,python2,autoreconf,systemd --parallel --max-parallel=$(maxparallel)

to
        dh $@ --with javahelper,python2,autoreconf --parallel --max-parallel=$(maxparallel) --dpkg-shlibdeps-params=--ignore-missing-info

replace
        dh_auto_install --no-parallel

to
        dh_auto_install


6. Build Ceph

dpkg-buildpackage -nc -d -j3


7. Build zstd deb packages

apt-get update ;apt-get install locales
apt-get install  gcc g++ cpp  git cmake autoconf bison flex dpkg-dev debhelper d-shlibs 
cd zstd-devuan/libzstd-1.1.2/
export CXXFLAGS+='-std=c++11'
dpkg-buildpackage -d -j3 

8. Build rocksdb deb packages

cd ../
dpkg -i libzstd1_1.1.2-1_armhf.deb  
dpkg -i libzstd-dev_1.1.2-1_armhf.deb 
dpkg -i zstd_1.1.2-1_armhf.deb 
cd ../
cd rocksdb-devuan/rocksdb-4.5.1/
export PORTABLE=1
apt-get install debhelper g++  libgflags-dev libgtest-dev libsnappy-dev libbz2-dev zlib1g-dev
Change debian/rules
uncommand export DH_VERBOSE=1
replace
dh $@ --dbg-package=librocksdb4.5-dbg --parallel --fail-missing
to
dh $@ --parallel --fail-missing
Change debian/control
add armhf into Architecture

dpkg-buildpackage -d -j3
dpkg-source: info: using source format `3.0 (quilt)'
dpkg-source: info: building rocksdb using existing ./rocksdb_4.5.1.orig.tar.gz
dpkg-source: info: building rocksdb in rocksdb_4.5.1-2.debian.tar.xz
dpkg-source: info: building rocksdb in rocksdb_4.5.1-2.dsc
 debian/rules build
dh build --parallel --fail-missing
   dh_testdir -O--parallel -O--fail-missing
   dh_auto_configure -O--parallel -O--fail-missing
   debian/rules override_dh_auto_build
make[1]: Entering directory '/tmp/rocksdb-devuan/rocksdb-4.5.1'
ARCH=armv7l
PORTABLE=1 DEBUG_LEVEL=0 make all
make[2]: Entering directory '/tmp/rocksdb-devuan/rocksdb-4.5.1'
/bin/sh: 1: ./db_test: not found
