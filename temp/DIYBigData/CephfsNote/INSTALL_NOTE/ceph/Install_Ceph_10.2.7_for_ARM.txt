# Basic setup
sudo apt-get update ;sudo apt-get install qemu-user-static
mkdir cephrootfs
sudo  tar -xvzf /src/fs/rootfs/debian-armhf-defaultrootfs.tgz -C cephrootfs/
dd if=/dev/zero of=swap bs=1M count=$((5*1024)) 
sudo mkswap swap 
sudo cp swap cephrootfs/var/
sudo cp /usr/bin/qemu-arm-static cephrootfs/usr/bin/qemu-arm-static 
sudo tar -zxvf ceph-10.2.7.tar.gz -C cephrootfs/tmp/
cat<<EOF| sudo chroot cephrootfs
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -o bind /dev/pts /dev/pts
EOF
sudo chroot cephrootfs
swapon /var/swap
apt-get update ;apt-get upgrade -y 


# Ceph setup
apt-get install libtool gcc git cmake autoconf bison flex
cd /tmp/ceph-10.2.7/
libtoolize --force
root@debian-build:/tmp/ceph-10.2.7# echo $?
0
aclocal
root@debian-build:/tmp/ceph-10.2.7# echo $?
0
autoheader
root@debian-build:/tmp/ceph-10.2.7# echo $?
0
automake --force-missing --add-missing
echo $?
0
autoconf
echo $?
0
mkdir objects
cd objects/
../install-deps.sh
apt-get install cython crypto libldap2-dev libsnappy-dev libleveldb-dev libblkid-dev libudev-dev libkeyutils-dev libcrypto++-dev libbeecrypt7  fuse libfuse-dev libgoogle-perftools-dev libatomic-ops-dev pkg-config libaio-dev xfslibs-dev libboost-system-dev libboost-iostreams-dev libboost-all-dev 
../configure --prefix=/usr/local/ --without-fuse
make
### Failed on rocksdb

### Cross compile rocksdb
cd /tmp
wget https://github.com/facebook/rocksdb/archive/v5.4.6.tar.gz
tar -zxvf v5.4.6.tar.gz
apt-get install libsnappy-dev zlib1g-dev  libbz2-dev libgflags-dev
wget https://github.com/facebook/zstd/archive/v1.1.3.tar.gz
mv v1.1.3.tar.gz zstd-1.1.3.tar.gz
tar zxvf zstd-1.1.3.tar.gz
cd zstd-1.1.3
make
make install
cd /tmp/rocksdb-5.4.6
PORTABLE=1 make static_lib
PORTABLE=1 make install

### Retry Make Ceph
cd  /tmp/ceph-10.2.7/objects
../configure --prefix=/usr/local/ --without-fuse
cd src/
mkdir rocksdb 
cd rocksdb/
ln -s  /usr/local/lib/librocksdb.a librocksdb.a 
cd ..
cd ..
make 
### Error
  CC       ceph_ver.lo
gcc: error: ceph_ver.c: No such file or directory
gcc: fatal error: no input files
compilation terminated.
Makefile:20663: recipe for target 'ceph_ver.lo' failed
make[3]: *** [ceph_ver.lo] Error 1
make[3]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:31098: recipe for target 'all-recursive' failed
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:12682: recipe for target 'all' failed
make[1]: *** [all] Error 2
make[1]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:697: recipe for target 'all-recursive' failed
make: *** [all-recursive] Error 1

## Retry 
cp ../src/ceph_ver.c src/
make


## Error
/usr/bin/ld: rocksdb/librocksdb.a(lru_cache.o): relocation R_ARM_THM_MOVW_ABS_NC against `a local symbol' can not be used when making a shared object; recompile with -fPIC
rocksdb/librocksdb.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Makefile:15986: recipe for target 'ceph-objectstore-tool' failed
make[3]: *** [ceph-objectstore-tool] Error 1
make[3]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:31098: recipe for target 'all-recursive' failed
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:12682: recipe for target 'all' failed
make[1]: *** [all] Error 2
make[1]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:697: recipe for target 'all-recursive' failed
make: *** [all-recursive] Error 1

## Retry 
export CFLAG='-fPIC'
export CXXFLAG='-fPIC'
make -j2 


## Some error
../tools/setup-virtualenv.sh: line 21: virtualenv: command not found
../tools/setup-virtualenv.sh: line 22: /tmp/ceph-detect-init-virtualenv/bin/activate: No such file or directory
../tools/setup-virtualenv.sh: line 25: pip: command not found
../tools/setup-virtualenv.sh: line 30: pip: command not found
../tools/setup-virtualenv.sh: line 32: pip: command not found
/bin/bash: /tmp/ceph-detect-init-virtualenv/bin/pip: No such file or directory



## Retry all
unset CFLAG CXXFLAG
cd /tmp/rocksdb-5.4.6
PORTABLE=1 make clean 
PORTABLE=1 make shared_lib -j3
PORTABLE=1 make install
cd ../ceph-10.2.7/

export CFLAG='-fPIC'
export CXXFLAG='-fPIC'
cd src/rocksdb/
cp /tmp/rocksdb-5.4.6/librocksdb.a .
cp /tmp/rocksdb-5.4.6/librocksdb.so* . 
cd /tmp/ceph-10.2.7/
cd objects/
../configure --prefix=/usr/local/ --without-fuse CXXFLAGS=' -fPIC' CFLAGS=' -fPIC'
cp ../src/ceph_ver.c src/ceph_ver.c
cp ../src/ceph_ver.h src/ceph_ver.h
cp -arf ../src/rocksdb src/
make -j3 


## Some Message
../../src/os/filestore/BtrfsFileStoreBackend.cc: In member function ‘virtual int BtrfsFileStoreBackend::create_current()’:
../../src/os/filestore/BtrfsFileStoreBackend.cc:269:26: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     if (currentfs.f_type == BTRFS_SUPER_MAGIC && basest.st_dev != st.st_dev) {
                          ^
../../src/os/filestore/BtrfsFileStoreBackend.cc: In member function ‘virtual int BtrfsFileStoreBackend::list_checkpoints(std::list<std::basic_string<char> >&)’:
../../src/os/filestore/BtrfsFileStoreBackend.cc:352:19: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
     if (fs.f_type == BTRFS_SUPER_MAGIC && basest.st_dev != st.st_dev)
                   ^
In file included from ../../src/common/Cycles.cc:38:0:
../../src/common/Cycles.h:82:2: warning: #warning No high-precision counter available for your OS/arch [-Wcpp]
 #warning No high-precision counter available for your OS/arch
  ^
  CXX      mds/MDCache.lo
../../src/mds/MDCache.cc: In member function 'void MDCache::request_cleanup(MDRequestRef&)':
../../src/mds/MDCache.cc:9128:8: warning: unused variable 'was_replay' [-Wunused-variable]
   bool was_replay = mdr->client_request && mdr->client_request->is_replay();

## Error
virtualenv/bin/pip install $NO_INDEX --use-wheel --find-links=file://$(pwd)/wheelhouse -e .
../tools/setup-virtualenv.sh: line 21: virtualenv: command not found
../tools/setup-virtualenv.sh: line 22: /tmp/ceph-detect-init-virtualenv/bin/activate: No such file or directory
../tools/setup-virtualenv.sh: line 25: pip: command not found
../tools/setup-virtualenv.sh: line 30: pip: command not found
../tools/setup-virtualenv.sh: line 32: pip: command not found
/bin/bash: /tmp/ceph-detect-init-virtualenv/bin/pip: No such file or directory
Makefile:32888: recipe for target '/tmp/ceph-detect-init-virtualenv' failed
make[3]: *** [/tmp/ceph-detect-init-virtualenv] Error 127
make[3]: *** Waiting for unfinished jobs....
make[3]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:31098: recipe for target 'all-recursive' failed
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:12682: recipe for target 'all' failed
make[1]: *** [all] Error 2
make[1]: Leaving directory '/tmp/ceph-10.2.7/objects/src'
Makefile:697: recipe for target 'all-recursive' failed
make: *** [all-recursive] Error 1

apt-get install virtualenv python-pip

## Retry again
make -j3


## Some message
#
  CXX      test/librbd/librbd_test_la-test_ImageWatcher.lo
In file included from ../../src/test/librbd/test_librbd.cc:24:0:
../../src/gmock/gtest/include/gtest/gtest.h: In instantiation of 'testing::AssertionResult testing::internal::CmpHelperEQ(const char*, const char*, const T1&, const T2&) [with T1 = unsigned int; T2 = int]':
../../src/gmock/gtest/include/gtest/gtest.h:1485:30:   required from 'static testing::AssertionResult testing::internal::EqHelper<lhs_is_null_literal>::Compare(const char*, const char*, const T1&, const T2&) [with T1 = unsigned int; T2 = int; bool lhs_is_null_literal = false]'
../../src/test/librbd/test_librbd.cc:3170:3:   required from here
../../src/gmock/gtest/include/gtest/gtest.h:1448:16: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
   if (expected == actual) {
                ^
#
  CXX      test/librbd/librbd_test_la-test_internal.lo
In file included from ../../src/test/librbd/test_fixture.h:7:0,
                 from ../../src/test/librbd/test_internal.cc:3:
../../src/gmock/gtest/include/gtest/gtest.h: In instantiation of 'testing::AssertionResult testing::internal::CmpHelperEQ(const char*, const char*, const T1&, const T2&) [with T1 = unsigned int; T2 = int]':
../../src/gmock/gtest/include/gtest/gtest.h:1485:30:   required from 'static testing::AssertionResult testing::internal::EqHelper<lhs_is_null_literal>::Compare(const char*, const char*, const T1&, const T2&) [with T1 = unsigned int; T2 = int; bool lhs_is_null_literal = false]'
../../src/test/librbd/test_internal.cc:591:5:   required from here
../../src/gmock/gtest/include/gtest/gtest.h:1448:16: warning: comparison between signed and unsigned integer expressions [-Wsign-compare]
   if (expected == actual) {
#
 CXX      tools/cephfs/JournalTool.o
../../src/tools/rbd_nbd/rbd-nbd.cc: In function ‘int do_map()’:
../../src/tools/rbd_nbd/rbd-nbd.cc:589:22: warning: left shift count >= width of type
   if (size > (1UL << 32) * 512) {
                      ^
../../src/tools/rbd_nbd/rbd-nbd.cc:592:34: warning: left shift count >= width of type
          << prettybyte_t((1UL << 32) * 512) << ")" << std::endl;
                                  ^
  CXX      tools/cephfs/JournalTool.o
../../src/tools/rbd_nbd/rbd-nbd.cc: In function ‘int do_map()’:
../../src/tools/rbd_nbd/rbd-nbd.cc:589:22: warning: left shift count >= width of type
   if (size > (1UL << 32) * 512) {
                      ^
../../src/tools/rbd_nbd/rbd-nbd.cc:592:34: warning: left shift count >= width of type
          << prettybyte_t((1UL << 32) * 512) << ")" << std::endl;
                                   ^
#
cd ../../src/ceph-disk ; ../tools/setup-virtualenv.sh /tmp/ceph-disk-virtualenv ; test -d wheelhouse && export NO_INDEX=--no-index ; /tmp/ceph-disk-virtualenv/bin/pip install $NO_INDEX --use-wheel --find-links=file://$(pwd)/wheelhouse -e .
Running virtualenv with interpreter /usr/bin/python2.7
New python executable in /tmp/ceph-disk-virtualenv/bin/python2.7
Also creating executable in /tmp/ceph-disk-virtualenv/bin/python
Installing setuptools, pip...done.
  AR       libkv.a
Downloading/unpacking pip>=6.1
  Downloading pip-9.0.1-py2.py3-none-any.whl (1.3MB):  14%  176kB  AR       libmon.a
  Downloading pip-9.0.1-py2.py3-none-any.whl (1.3MB): 1.3MB downloaded
Installing collected packages: pip
  Found existing installation: pip 1.5.6
    Uninstalling pip:
      Successfully uninstalled pip
  AR       libos_types.a
  AR       libosd.a
Successfully installed pip
Cleaning up...
if [ -n "$NO_VERSION" ] ; then \
	../../src/make_version -g ../../src/.git_version -c ../../src/ceph_ver.h -n ; \
else \
	../../src/make_version -g ../../src/.git_version -c ../../src/ceph_ver.h ; \
fi
This is no git repository, not updating .git_version
  CXXLD    libcrush.la
Collecting tox>=1.9
  Url 'file:///tmp/ceph-10.2.7/src/ceph-disk/wheelhouse' is ignored: it is neither a file nor a directory.
  CXX      compressor/snappy/libceph_snappy_la-CompressionPluginSnappy.lo
  Downloading tox-2.7.0-py2.py3-none-any.whl (49kB)
    100% |████████████████████████████████| 51kB 333kB/s 
Collecting virtualenv>=1.11.2; python_version != "3.2" (from tox>=1.9)
  Url 'file:///tmp/ceph-10.2.7/src/ceph-disk/wheelhouse' is ignored: it is neither a file nor a directory.
  Downloading virtualenv-15.1.0-py2.py3-none-any.whl (1.8MB)
    100% |████████████████████████████████| 1.8MB 123kB/s 
Collecting py>=1.4.17 (from tox>=1.9)
  Url 'file:///tmp/ceph-10.2.7/src/ceph-disk/wheelhouse' is ignored: it is neither a file nor a directory.
  Downloading py-1.4.34-py2.py3-none-any.whl (84kB)
    100% |████████████████████████████████| 92kB 1.3MB/s 
Collecting pluggy<1.0,>=0.3.0 (from tox>=1.9)
  Url 'file:///tmp/ceph-10.2.7/src/ceph-disk/wheelhouse' is ignored: it is neither a file nor a directory.
  Downloading pluggy-0.4.0-py2.py3-none-any.whl
Installing collected packages: virtualenv, py, pluggy, tox
Successfully installed pluggy-0.4.0 py-1.4.34 tox-2.7.0 virtualenv-15.1.0
Requirement already satisfied: argparse in /usr/lib/python2.7 (from -r requirements.txt (line 1))
Obtaining file:///tmp/ceph-10.2.7/src/ceph-disk
Requirement already satisfied: setuptools in /tmp/ceph-disk-virtualenv/lib/python2.7/site-packages (from ceph-disk==1.0.0)
Installing collected packages: ceph-disk
  Running setup.py develop for ceph-disk
Successfully installed ceph-disk
#
rm -f ceph ceph.tmp
cp ceph.in ceph.tmp
/bin/cp: cannot stat ‘ceph.in’: No such file or directory
Makefile:33187: recipe for target 'ceph' failed
make[3]: *** [ceph] Error 1
make[3]: *** Waiting for unfinished jobs....


### Retry All

cd /tmp
rm -rf ceph-10.2.7
tar -zxvf ceph-10.2.7.tar.gz
cd ceph-10.2.7
export CFLAGS='-fPIC'
export CXXFLAGS='-fPIC'
cd src/rocksdb/
cp /tmp/rocksdb-5.4.6/librocksdb.a .
cp /tmp/rocksdb-5.4.6/librocksdb.so* . 
cd /tmp/ceph-10.2.7/
./configure --prefix=/usr/local/ --without-fuse CXXFLAGS=' -fPIC' CFLAGS=' -fPIC'
make -j3

/usr/bin/ld: rocksdb/librocksdb.a(db_impl_open.o): relocation R_ARM_THM_MOVW_ABS_NC against `a local symbol' can not be used when making a shared object; recompile with -fPIC
rocksdb/librocksdb.a: error adding symbols: Bad value
collect2: error: ld returned 1 exit status
Makefile:15987: recipe for target 'ceph-objectstore-tool' failed
make[3]: *** [ceph-objectstore-tool] Error 1
make[3]: *** Waiting for unfinished jobs....
make[3]: Leaving directory '/tmp/ceph-10.2.7/src'
Makefile:31099: recipe for target 'all-recursive' failed
make[2]: *** [all-recursive] Error 1
make[2]: Leaving directory '/tmp/ceph-10.2.7/src'
Makefile:12684: recipe for target 'all' failed
make[1]: *** [all] Error 2
make[1]: Leaving directory '/tmp/ceph-10.2.7/src'
Makefile:708: recipe for target 'all-recursive' failed
make: *** [all-recursive] Error 1

### Retry again
cd src/rocksdb
cp -arf /tmp/rocksdb-5.4.6/* .
cd ../../
export CFLAGS='-fPIC'
export CXXFLAGS='-fPIC'
export LDFLAGS='-fPIC'
swapon /var/swap 
./configure --prefix=/usr/local/ --without-fuse CXXFLAGS=' -fPIC' CFLAGS=' -fPIC' LDFLAGS=' -fPIC'
